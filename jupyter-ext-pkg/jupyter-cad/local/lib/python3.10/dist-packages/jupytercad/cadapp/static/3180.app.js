"use strict";(self.webpackChunk_JUPYTERLAB_CORE_OUTPUT=self.webpackChunk_JUPYTERLAB_CORE_OUTPUT||[]).push([[3180],{53180:(e,t,s)=>{s.r(t),s.d(t,{IJupyterYWidgetManager:()=>_,JupyterYDoc:()=>n,JupyterYModel:()=>d,default:()=>b,notebookRenderer:()=>D,yWidgetManager:()=>S});var i=s(50558),r=s(53968),o=s(70040);class d{constructor(e){this._isDisposed=!1,this._disposed=new r.Signal(this),this._yModelName=e.ymodel_name;const t=this.ydocFactory(e);this._sharedModel=new n(e,t)}get yModelName(){return this._yModelName}get sharedModel(){return this._sharedModel}get sharedAttrsChanged(){return this.sharedModel.attrsChanged}get disposed(){return this._disposed}get isDisposed(){return this._isDisposed}ydocFactory(e){return new o.Doc}dispose(){this._isDisposed||(this._isDisposed=!0,this._sharedModel.dispose(),this._disposed.emit(),r.Signal.clearData(this))}addAttr(e,t){this.sharedModel.setAttr(e,t)}removeAttr(e){this.sharedModel.removeAttr(e)}}class n{constructor(e,t){this._attrsObserver=e=>{this._attrsChanged.emit(e.keys)},this._attrsChanged=new r.Signal(this),this._isDisposed=!1,this._disposed=new r.Signal(this),this._commMetadata=e,this._ydoc=t,e.create_ydoc&&(this._attrs=this._ydoc.getMap("_attrs"),this._attrs.observe(this._attrsObserver))}get commMetadata(){return this._commMetadata}get ydoc(){return this._ydoc}get attrs(){return i.JSONExt.deepCopy(this._attrs.toJSON())}get attrsChanged(){return this._attrsChanged}get disposed(){return this._disposed}get isDisposed(){return this._isDisposed}dispose(){this._isDisposed||(this._attrs.unobserve(this._attrsObserver),this._disposed.emit(),r.Signal.clearData(this),this._isDisposed=!0)}getAttr(e){return this._attrs.get(e)}setAttr(e,t){this._attrs.set(e,t)}removeAttr(e){this._attrs.has(e)&&this._attrs.delete(e)}}var a=s(80935),c=s(39003);class h{constructor(e){this._isDisposed=!1,this._widgetManager=e.widgetManager,this._kernelId=e.kernelId}get isDisposed(){return this._isDisposed}dispose(){this._isDisposed||(this._isDisposed=!0)}getYModel(e){if(this._kernelId)return this._widgetManager.getWidgetModel(this._kernelId,e)}createYWidget(e,t){if(this._kernelId){const s=this._widgetManager.getWidgetModel(this._kernelId,e);s&&new(this._widgetManager.getWidgetFactory(s.yModelName))(s,t)}}}const _=new i.Token("yjs-widgets:IJupyterYWidgetManager","A manager of Yjs-based Jupyter widgets.");var g=s(23190);class l extends g.Widget{constructor(e){super(),this._modelFactory=e.modelFactory,this._mimeType=e.mimeType,this.addClass("mimerenderer-jupyterywidget")}dispose(){var e;this.isDisposed||(null===(e=this._yModel)||void 0===e||e.dispose(),super.dispose())}async renderModel(e){const t=e.data[this._mimeType].model_id;this._yModel=this._modelFactory.getYModel(t),this._yModel&&this._modelFactory.createYWidget(t,this.node)}}var y=s(94072),u=s(69476);const p=(e,t,s)=>{u.uE(e,1),u.mP(e,o.encodeStateAsUpdate(t,s))},m=(e,t,s)=>{try{o.applyUpdate(t,y.HN(e),s)}catch(e){console.error("Caught error while handling a Yjs update",e)}},M=m;var w,v;!function(e){e[e.SYNC=0]="SYNC",e[e.AWARENESS=1]="AWARENESS"}(w||(w={}));class f{constructor(e){this._onMsg=e=>{if(e.buffers){const t=e.buffers[0],s=new Uint8Array(ArrayBuffer.isView(t)?t.buffer:t),i=v.readMessage(this,s,!0);u.kE(i)>1&&this._sendOverComm(u._f(i))}},this._updateHandler=(e,t)=>{const s=u.Mf();u.uE(s,w.SYNC),((e,t)=>{u.uE(e,2),u.mP(e,t)})(s,e),this._sendOverComm(u._f(s))},this._isDisposed=!1,this._comm=e.comm,this._ydoc=e.ydoc,this._ydoc.on("update",this._updateHandler),this._connect()}get doc(){return this._ydoc}get synced(){return this._synced}set synced(e){this._synced!==e&&(this._synced=e)}get isDisposed(){return this._isDisposed}dispose(){this._isDisposed||(this._comm.close(),this._isDisposed=!0)}_connect(){this._sync(),this._comm.onMsg=this._onMsg}_sync(){const e=u.Mf();u.uE(e,w.SYNC),((e,t)=>{u.uE(e,0);const s=o.encodeStateVector(t);u.mP(e,s)})(e,this._ydoc),this._sendOverComm(u._f(e))}_sendOverComm(e){this._comm.send({},void 0,[e.buffer])}}!function(e){function t(e,t,s,i){u.uE(e,w.SYNC);const r=((e,t,s,i)=>{const r=y.yg(e);switch(r){case 0:((e,t,s)=>{p(t,s,y.HN(e))})(e,t,s);break;case 1:m(e,s,i);break;case 2:M(e,s,i);break;default:throw new Error("Unknown message type")}return r})(t,e,s.doc,s);i&&1===r&&!s.synced&&(p(e,s.doc),s.synced=!0)}e.syncMessageHandler=t,e.readMessage=function(e,s,i){const r=y.l1(s),o=u.Mf();return y.yg(r)===w.SYNC?t(o,r,e,i):console.error("Unable to compute message"),o}}(v||(v={}));class k{constructor(){this._registry=new Map,this._yModelFactories=new Map,this._yWidgetFactories=new Map}registerKernel(e){const t=this._yModelFactories,s=new C({kernel:e,yModelFactories:t});this._registry.set(e.id,s)}unregisterKernel(e){e&&this._registry.delete(e)}registerWidget(e,t,s){this._yModelFactories.set(e,t),this._yWidgetFactories.set(e,s)}getWidgetModel(e,t){var s;return null===(s=this._registry.get(e))||void 0===s?void 0:s.getModel(t)}getWidgetFactory(e){return this._yWidgetFactories.get(e)}}class C{constructor(e){this._handle_comm_open=async(e,t)=>{const s=new(this._yModelFactories.get(t.metadata.ymodel_name))(t.metadata);new f({comm:e,ydoc:s.sharedModel.ydoc}),this._yModels.set(e.commId,s)},this._yModels=new Map;const{kernel:t,yModelFactories:s}=e;this._yModelFactories=s,t.registerCommTarget("ywidget",this._handle_comm_open)}getModel(e){return this._yModels.get(e)}}const D={id:"jupyterywidget:notebookRenderer",autoStart:!0,requires:[c.IRenderMimeRegistry,a.INotebookTracker,_],activate:(e,t,s,i)=>{const r={safe:!0,mimeTypes:["application/vnd.jupyter.ywidget-view+json"],createRenderer:e=>{var t,r,o;const d=null===(o=null===(r=null===(t=s.currentWidget)||void 0===t?void 0:t.sessionContext.session)||void 0===r?void 0:r.kernel)||void 0===o?void 0:o.id,n=e.mimeType,a=new h({kernelId:d,widgetManager:i});return new l({mimeType:n,modelFactory:a})}};t.addFactory(r,-100)}},S={id:"yjs-widgets:yWidgetManagerPlugin",autoStart:!0,requires:[a.INotebookTracker],provides:_,activate:(e,t)=>{const s=new k,i=(e,t)=>{const{newValue:i,oldValue:r}=t;i&&(s.unregisterKernel(null==r?void 0:r.id),s.registerKernel(i),i.disposed.connect((()=>{s.unregisterKernel(i.id)})))};return t.widgetAdded.connect((async(e,t)=>{t.sessionContext.kernelChanged.connect(i),t.disposed.connect((()=>{t.sessionContext.kernelChanged.disconnect(i)}))})),s}},b=[D,S]}}]);